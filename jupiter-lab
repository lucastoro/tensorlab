#!/bin/bash

# for instructions on how to compile your own TENSORFLOW_WHEEL:
# https://www.tensorflow.org/install/source

DOCKER=nvidia-docker

function build {
  local TENSORFLOW_WHEEL=$1

  [[ -z "$TENSORFLOW_WHEEL" ]] && {
    echo 'missing tensorflow wheel file'
    exit 1
  }

  [[ -r "$TENSORFLOW_WHEEL" ]] || {
    echo "cannot read $TENSORFLOW_WHEEL"
    exit 1
  }

  local TMPDIR=$(mktemp -d)
  cp $TENSORFLOW_WHEEL $TMPDIR
  TENSORFLOW_WHEEL=$(basename $TENSORFLOW_WHEEL)
  pushd $TMPDIR
  echo "\
FROM tensorflow/tensorflow:latest-gpu-jupyter 
COPY $TENSORFLOW_WHEEL /tmp/
RUN apt update && apt install -y python3-pip wget rsync
RUN pip3 install --upgrade pip
RUN pip3 install jupyterlab matplotlib ipyvolume
RUN pip3 install /tmp/$TENSORFLOW_WHEEL
RUN rm /tmp/$TENSORFLOW_WHEEL
# nodejs is needed by some notebook extensions like ipyvolume, 16:04 has an outdated version, must be installed by tarball
RUN wget https://nodejs.org/dist/v10.15.3/node-v10.15.3-linux-x64.tar.xz
RUN tar -xf node-v10.15.3-linux-x64.tar.xz
RUN rsync -a node-v10.15.3-linux-x64/ /usr/
RUN rm node-v10.15.3-linux-x64.tar.xz
RUN rm -r node-v10.15.3-linux-x64
# ipyvolume needs a bit of work to be enabled
RUN jupyter labextension install @jupyter-widgets/jupyterlab-manager
RUN jupyter labextension install ipyvolume
RUN jupyter labextension install jupyter-threejs
RUN mkdir /.ipyvolume
RUN chmod 777 /.ipyvolume
# default to running the lab
CMD [\"jupyter\", \"lab\", \"--no-browser\", \"--notebook-dir=/media/shared\"]" >> Dockerfile
  
  $DOCKER build -t jupyterlab:tensorflow .
  local RESULT=$?
  popd; rm -rf $TMPDIR
  return $RESULT
}

function launch {
  $DOCKER run --net host --rm -it -v $PWD:/media/shared -u $(id -u):$(id -g) jupyterlab:tensorflow $@ 
}

[[ "$1" == '--build' || "$1" == '-b' ]] && {
  shift; build $@
} || {
  launch $@
}
